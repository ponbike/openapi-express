{"version":3,"file":"openapi-express.modern.js","sources":["../src/entities/api.js","../src/api-schema.js","../src/openapi-express.js"],"sourcesContent":["class API {\n  constructor () {\n    this.version = 'v1'\n    this.specification = {}\n    this.controllers = {}\n    this.secret = null\n    this.requestValidation = false\n    this.responseValidation = false\n  }\n\n  /**\n   * Set the version\n   *\n   * @param {string} version\n   */\n  setVersion (version) {\n    if (!version || version.constructor !== String) {\n      throw new Error('Invalid OpenAPI version')\n    }\n\n    this.version = version\n  }\n\n  /**\n   * Set the specification\n   *\n   * @param {object} specification\n   */\n  setSpecification (specification) {\n    if (!specification || specification.constructor !== Object) {\n      throw new Error('Invalid OpenAPI specification')\n    }\n\n    this.specification = specification\n  }\n\n  /**\n   * Set the controllers\n   *\n   * @param {object} controllers\n   */\n  setControllers (controllers) {\n    if (!controllers || controllers.constructor !== Object) {\n      throw new Error('Invalid OpenAPI controllers')\n    }\n\n    this.controllers = controllers\n  }\n\n  /**\n   * Set the secret\n   *\n   * @param {string} secret\n   */\n  setSecret (secret) {\n    if (secret && secret.constructor !== String) {\n      throw new Error('Invalid OpenAPI secret')\n    }\n\n    this.secret = secret\n  }\n\n  /**\n   * set the request validation\n   *\n   * @param {boolean} val\n   */\n  setRequestValidation (val) {\n    if (val.constructor !== Boolean) {\n      throw new Error('Invalid request validation')\n    }\n    this.requestValidation = val\n  }\n\n  /**\n   * set the response validation\n   *\n   * @param {boolean} val\n   */\n  setResponseValidation (val) {\n    if (val.constructor !== Boolean) {\n      throw new Error('Invalid response validation')\n    }\n    this.responseValidation = val\n  }\n\n  /**\n   * Create an API entity\n   *\n   * @param {string} version\n   * @param {object} specification\n   * @param {object} controllers\n   * @param {string} secret\n   * @param {boolean} requestValidation\n   * @param {boolean} responseValidation\n   *\n   * @return {object}\n   */\n  static create ({ version, specification, controllers, secret, requestValidation = false, responseValidation = false }) {\n    const api = new API()\n\n    api.setVersion(version)\n    api.setSpecification(specification)\n    api.setControllers(controllers)\n    api.setSecret(secret)\n    api.setRequestValidation(requestValidation)\n    api.setResponseValidation(responseValidation)\n\n    return api\n  }\n}\n\nexport default API\n","export default {\n  name: 'string',\n  version: 'string',\n  apis: {\n    version: 'string',\n    specification: 'object',\n    controllers: 'object',\n    requestValidation: 'boolean',\n    //    responseValidation: 'boolean',\n    '?secret': 'string'\n  },\n  '?poweredBy': 'string',\n  '?limit': 'string',\n  '?staticFolder': 'string'\n}\n","import express from 'express'\nimport swaggerUi from 'swagger-ui-express'\nimport cors from 'cors'\nimport compression from 'compression'\nimport helmet from 'helmet'\nimport expressPino from 'express-pino-logger'\nimport { logger as stackdriver } from '@ponbike/logger-stackdriver'\nimport { ApiRoutes } from '@ponbike/openapi-routes'\nimport { OpenAPIBackend } from 'openapi-backend'\nimport { makeExpressCallback } from '@hckrnews/express-callback'\nimport { Validator } from '@hckrnews/validator'\nimport API from './entities/api.js'\nimport apiSchema from './api-schema.js'\nimport dotenv from 'dotenv'\n\ndotenv.config()\nconst logger = stackdriver()\nconst apiValidator = new Validator(apiSchema)\n\n/**\n * Build the Open API Express server.\n *\n * @param {string} name\n * @param {string} version\n * @param {array} apis\n * @param {string} poweredBy\n * @param {string} staticFolder\n * @param {string} limit\n * @param {object} loggerOptions\n *\n * @return {object}\n */\nconst buildOpenapiExpress = ({ name, version, apis, poweredBy = 'Pon.Bike', staticFolder = null, limit = '100mb', loggerOptions = {} }) => {\n  if (!apiValidator.validate({ name, version, apis, poweredBy, staticFolder })) {\n    throw new Error('invalid api details, field ' + apiValidator.errors[0][0] + ' should be a ' + apiValidator.errors[0][1])\n  }\n\n  const app = express()\n  const apiLogger = stackdriver(loggerOptions)\n\n  app.set('name', name)\n  app.use(cors())\n  app.use(compression())\n  app.use(helmet())\n  app.use(express.json({ limit }))\n  app.use((request, response, next) => {\n    response.setHeader('X-Powered-By', poweredBy)\n    response.setHeader('X-Version', version)\n    next()\n  })\n  app.use(expressPino({ logger: apiLogger }))\n  app.set('logger', apiLogger)\n\n  apis.forEach((api) => {\n    const apiRoutes = makeApi(api, apiLogger)\n    app.use('/' + api.version, apiRoutes)\n  })\n\n  if (staticFolder) {\n    app.use(express.static(staticFolder))\n  }\n\n  app.use(function (request, response, next) {\n    response.status(404).send({\n      status: 404,\n      timestamp: new Date(),\n      message: 'Not found.'\n    })\n  })\n\n  return app\n}\n\n/**\n * Connect the openapi spec to the controllers.\n *\n * @param {object} api\n * @param {P.Logger} apiLogger\n *\n * @return {object}\n */\nconst makeApi = (api, apiLogger) => {\n  const { specification, controllers, secret, requestValidation = false, responseValidation = false } = API.create(api)\n  const router = express.Router()\n  router.use('/swagger', swaggerUi.serve, swaggerUi.setup(specification))\n  router.get('/api-docs', (request, response) =>\n    response.json(specification)\n  )\n\n  const { api: apiRoutes } = ApiRoutes.create({\n    specification,\n    secret,\n    Backend: OpenAPIBackend,\n    logger: apiLogger,\n    controllers,\n    callback: makeExpressCallback,\n    root: '/',\n    responseValidation,\n    requestValidation\n  })\n\n  router.use((request, response) =>\n    apiRoutes.handleRequest(\n      request,\n      request,\n      response\n    )\n  )\n\n  return router\n}\n\nexport default buildOpenapiExpress\nexport {\n  buildOpenapiExpress,\n  makeApi,\n  API,\n  logger,\n  apiValidator,\n  apiSchema\n}\n"],"names":["API","constructor","version","specification","controllers","secret","requestValidation","responseValidation","setVersion","String","Error","setSpecification","Object","setControllers","setSecret","setRequestValidation","val","Boolean","setResponseValidation","create","api","name","apis","dotenv","config","logger","stackdriver","apiValidator","Validator","apiSchema","buildOpenapiExpress","poweredBy","staticFolder","limit","loggerOptions","validate","errors","app","express","apiLogger","set","use","cors","compression","helmet","json","request","response","next","setHeader","expressPino","forEach","apiRoutes","makeApi","static","status","send","timestamp","Date","message","router","Router","swaggerUi","serve","setup","get","ApiRoutes","Backend","OpenAPIBackend","callback","makeExpressCallback","root","handleRequest"],"mappings":"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"}