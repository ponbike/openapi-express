{"version":3,"file":"openapi-express.umd.js","sources":["../src/pino-logger-stackdriver.js","../src/openapi-express.js"],"sourcesContent":["/*\n    Pino Stackdriver logger\n\n    The Pino Logger, but with a format that stackdriver understands\n\n    This will be a package, source code:\n    https://bitbucket.org/ponbikedmp/node-logger-stackdriver/src/main/\n */\nimport pino from 'pino'\n\nconst PINO_DEFAULT_LEVEL = 'info'\n\nconst PinoLevelToSeverity = {\n  trace: 'DEBUG',\n  debug: 'DEBUG',\n  info: 'INFO',\n  warn: 'WARNING',\n  error: 'ERROR',\n  fatal: 'CRITICAL'\n}\n\nconst defaultPinoConf = {\n  messageKey: 'message',\n  formatters: {\n    level (label, number) {\n      return {\n        severity: PinoLevelToSeverity[label] || PinoLevelToSeverity[PINO_DEFAULT_LEVEL],\n        level: number\n      }\n    },\n    log (message) {\n      return { message }\n    }\n  }\n}\n\n/**\n * Returns a new Pino Logger instance with stackdriver ready logs!\n *\n * @param {object} options\n * @returns {P.Logger} a new Pino logger instance with stackdriver ready logs\n */\n\nexport default (options) => pino({ ...options, ...defaultPinoConf })\n","import express from 'express'\nimport swaggerUi from 'swagger-ui-express'\nimport cors from 'cors'\nimport compression from 'compression'\nimport helmet from 'helmet'\nimport expressPino from 'express-pino-logger'\nimport stackdriver from './pino-logger-stackdriver.js'\nimport { ApiRoutes } from '@hckrnews/openapi-routes'\nimport { OpenAPIBackend } from 'openapi-backend'\nimport { makeExpressCallback } from '@hckrnews/express-callback'\n\nconst logger = stackdriver()\n\n/**\n * Build the Open API Express server.\n *\n * @param {string} name\n * @param {string} version\n * @param {array} apis\n * @param {array} poweredBy\n * @param {string} staticFolder\n *\n * @return {object}\n */\nexport default function buildOpenapiExpress ({ name, version, apis, poweredBy = 'Pon.Bike', staticFolder = null }) {\n  const app = express()\n\n  app.set('name', name)\n  app.use(cors())\n  app.use(compression())\n  app.use(helmet())\n  app.use(express.json())\n  app.use((request, response, next) => {\n    response.setHeader('X-Powered-By', poweredBy)\n    response.setHeader('X-Version', version)\n    next()\n  })\n  app.use(expressPino({ logger }))\n  app.set('logger', logger)\n\n  apis.forEach((api) => {\n    app.use('/' + api.version, makeApi(api))\n  })\n\n  if (staticFolder) {\n    if (staticFolder.constructor !== String) {\n      throw new Error('staticFolder isnt a valid string to the static files folder')\n    }\n\n    app.use(express.static(staticFolder))\n  }\n\n  app.use(function (request, response, next) {\n    response.status(404).send({\n      status: 404,\n      timestamp: new Date(),\n      message: 'Not found.'\n    })\n  })\n\n  return app\n}\n\n/**\n * Connect the openapi spec to the controllers.\n *\n * @param {object} specification\n * @param {object} controllers\n * @param {string} secret\n *\n * @return {object}\n */\nconst makeApi = ({ specification, controllers, secret }) => {\n  const router = express.Router()\n  router.use('/swagger', swaggerUi.serve, swaggerUi.setup(specification))\n  router.get('/api-docs', (request, response) =>\n    response.json(specification)\n  )\n\n  router.use((request, response) =>\n    ApiRoutes.create({\n      specification: specification,\n      secret,\n      Backend: OpenAPIBackend,\n      logger,\n      controllers,\n      callback: makeExpressCallback,\n      root: '/'\n    }).handleRequest(\n      request,\n      request,\n      response\n    )\n  )\n\n  return router\n}\n"],"names":["PINO_DEFAULT_LEVEL","PinoLevelToSeverity","trace","debug","info","warn","error","fatal","defaultPinoConf","messageKey","formatters","level","label","number","severity","log","message","options","pino","logger","stackdriver","buildOpenapiExpress","name","version","apis","poweredBy","staticFolder","app","express","set","use","cors","compression","helmet","json","request","response","next","setHeader","expressPino","forEach","api","makeApi","constructor","String","Error","static","status","send","timestamp","Date","specification","controllers","secret","router","Router","swaggerUi","serve","setup","get","ApiRoutes","create","Backend","OpenAPIBackend","callback","makeExpressCallback","root","handleRequest"],"mappings":"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"}